class PingPongGame{constructor(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.startScreen=document.getElementById("startScreen"),this.gameUI=document.getElementById("gameUI"),this.gameOverScreen=document.getElementById("gameOverScreen"),this.podiumScreen=document.getElementById("podiumScreen"),this.podiumCanvas=document.getElementById("podiumCanvas"),this.podiumCtx=this.podiumCanvas?this.podiumCanvas.getContext("2d"):null,this.podiumWinner=document.getElementById("podiumWinner"),this.podiumCountdown=document.getElementById("podiumCountdown"),this.leaderboard=document.getElementById("leaderboard"),this.leaderboardTitle=document.getElementById("leaderboardTitle"),this.scoreList=document.getElementById("scoreList"),this.leftScoreDisplay=document.getElementById("leftScore"),this.rightScoreDisplay=document.getElementById("rightScore"),this.leftBonusScoreDisplay=document.getElementById("leftBonusScore"),this.rightBonusScoreDisplay=document.getElementById("rightBonusScore"),this.gameTimeDisplay=document.getElementById("gameTime"),this.winnerText=document.getElementById("winnerText"),this.finalScore=document.getElementById("finalScore"),this.leftPlayerDisplay=document.getElementById("leftPlayerDisplay"),this.rightPlayerDisplay=document.getElementById("rightPlayerDisplay"),this.leftPlayerInput=document.getElementById("leftPlayerName"),this.rightPlayerInput=document.getElementById("rightPlayerName"),this.leftPlayerDisplayDiv=document.getElementById("leftPlayerDisplay"),this.rightPlayerDisplayDiv=document.getElementById("rightPlayerDisplay"),this.db=null,this.initDatabase(),this.leaderboardState={currentView:"recent",switchTimer:0,switchInterval:5e3,autoSwitch:!0},this.leftNameSet=!1,this.rightNameSet=!1,this.tableSizeSelect=document.getElementById("tableSize"),this.backgroundSelect=document.getElementById("background"),this.detailedStats=document.getElementById("detailedStats"),this.totalScores=document.getElementById("totalScores"),this.regularScores=document.getElementById("regularScores"),this.bonusScores=document.getElementById("bonusScores"),this.gameDuration=document.getElementById("gameDuration"),this.autoMove={enabled:!1,lastControlTime:0,successRate:.8,reactionDelay:200,lastDecisionTime:0,targetY:0,activationDelay:5e3},this.gameState="start",this.showDetailedStats=!1,this.podiumState={active:!1,countdown:20,countdownTimer:0,winner:null,animationFrame:0,fireworks:[],winnerDance:{frame:0,speed:.2},loserSad:{frame:0,speed:.1},tears:[]},this.tableSizes={standard:{width:1380,height:600,tableWidth:1200,tableHeight:600},large:{width:1680,height:750,tableWidth:1500,tableHeight:750}},this.currentTableSize="standard",this.backgrounds={classic:{base:"#0a4a1a",pattern:null},dark:{base:"#1a1a1a",pattern:"dots"},blue:{base:"#1a3a5a",pattern:"lines"},wood:{base:"#8B4513",pattern:"wood"},neon:{base:"#0a0a2a",pattern:"grid"}},this.currentBackground="classic",this.leftPlayerName="小鹏友",this.rightPlayerName="唐林",this.paddleWidth=20,this.paddleHeight=160,this.paddleSpeed=10,this.leftPaddle={x:20,y:this.canvas.height/2-this.paddleHeight/2,width:this.paddleWidth,height:this.paddleHeight,speed:this.paddleSpeed},this.rightPaddle={x:this.canvas.width-30,y:this.canvas.height/2-this.paddleHeight/2,width:this.paddleWidth,height:this.paddleHeight,speed:this.paddleSpeed},this.ballSize=30,this.ball={x:this.canvas.width/2,y:this.canvas.height/2,dx:4,dy:3,size:this.ballSize,baseSpeed:4,trail:[],color:this.getRandomBrightColor()},this.lastLoser=null,this.outOfBoundsAnimation={active:!1,particles:[],duration:60,currentFrame:0},this.leftScore=0,this.rightScore=0,this.leftBonusScore=0,this.rightBonusScore=0,this.winningScore=21,this.apples=[],this.appleSystem={maxApples:3,spawnTimer:0,spawnInterval:180+240*Math.random(),lastSpawnTime:0},this.keys={},this.gamepads={},this.gamepadConnected=!1,this.cursor={x:window.innerWidth/2,y:window.innerHeight/2,visible:!1,speed:8},this.lastHitPlayer=null,this.gameStartTime=0,this.currentGameTime=0,this.hitSound=new Audio("sound/hit.mp3"),this.hitSound.volume=.8,this.backgroundMusic=new Audio("sound/比赛的一天.mp3"),this.backgroundMusic.volume=.6,this.backgroundMusic.loop=!0,this.leftLostSound=new Audio("sound/left_lost_mp3.mp3"),this.leftLostSound.volume=.7,this.rightLostSound=new Audio("sound/right_lost.mp3"),this.rightLostSound.volume=.7,this.gameEndSound=new Audio("sound/vector.mp3"),this.gameEndSound.volume=.8,this.leftCharacter={x:10,y:this.canvas.height/2,width:80,height:100,animationFrame:0,animationSpeed:.15,size:2,isEnhanced:!1,enhancedTimer:0,paddleSpeedMultiplier:1,enhancementCount:0,paddleHeightMultiplier:1},this.rightCharacter={x:652,y:this.canvas.height/2,width:80,height:100,animationFrame:0,animationSpeed:.15,size:2,isEnhanced:!1,enhancedTimer:0,paddleSpeedMultiplier:1,enhancementCount:0,paddleHeightMultiplier:1},this.scoreAnimation={active:!1,text:"",x:0,y:0,opacity:1,scale:1,duration:120,currentFrame:0},this.initEventListeners(),this.initGamepadSupport(),this.initializeTableSize(),this.updateStartHint(),this.startScreenLoop()}startScreenLoop(){"start"===this.gameState&&(this.handleGamepadInput(),requestAnimationFrame(()=>this.startScreenLoop()))}async initDatabase(){try{const t=window.indexedDB.open("PingPongScores",1);t.onerror=()=>{},t.onsuccess=t=>{this.db=t.target.result},t.onupgradeneeded=t=>{const e=t.target.result;if(!e.objectStoreNames.contains("scores")){const t=e.createObjectStore("scores",{keyPath:"id",autoIncrement:!0});t.createIndex("totalScore","totalScore",{unique:!1}),t.createIndex("date","date",{unique:!1})}}}catch(t){}}async saveScore(t,e,i,s,a,h,l){if(!this.db)return;const r=this.db.transaction(["scores"],"readwrite").objectStore("scores"),n={leftPlayer:t,rightPlayer:e,leftScore:i,leftBonus:s,rightScore:a,rightBonus:h,leftTotal:i+s,rightTotal:a+h,totalScore:i+s+a+h,winner:i+s>a+h?t:e,date:new Date,duration:l};r.add(n)}async getScores(){return this.db?new Promise((t,e)=>{const i=this.db.transaction(["scores"],"readonly").objectStore("scores").getAll();i.onsuccess=()=>{const e=i.result;e.sort((t,e)=>new Date(e.date)-new Date(t.date)),t(e.slice(0,10))},i.onerror=()=>{e(i.error)}}):[]}async getPlayerRankings(){return this.db?new Promise((t,e)=>{const i=this.db.transaction(["scores"],"readonly").objectStore("scores").getAll();i.onsuccess=()=>{const e=i.result,s={};e.forEach(t=>{s[t.leftPlayer]||(s[t.leftPlayer]={name:t.leftPlayer,totalScore:0,wins:0,games:0}),s[t.leftPlayer].totalScore+=t.leftTotal,s[t.leftPlayer].games+=1,t.winner===t.leftPlayer&&(s[t.leftPlayer].wins+=1),s[t.rightPlayer]||(s[t.rightPlayer]={name:t.rightPlayer,totalScore:0,wins:0,games:0}),s[t.rightPlayer].totalScore+=t.rightTotal,s[t.rightPlayer].games+=1,t.winner===t.rightPlayer&&(s[t.rightPlayer].wins+=1)});const a=Object.values(s).sort((t,e)=>e.totalScore-t.totalScore).slice(0,10);t(a)},i.onerror=()=>{e(i.error)}}):[]}showLeaderboardFromGame(){this.gameOverScreen.style.display="none",this.leaderboard.style.display="flex",this.resetLeaderboardState(),this.loadScores(),this.startLeaderboardLoop()}hideLeaderboardToGame(){this.leaderboard.style.display="none",this.gameOverScreen.style.display="block",this.leaderboardState.autoSwitch=!1}showLeaderboard(){this.startScreen.style.display="none",this.leaderboard.style.display="flex",this.resetLeaderboardState(),this.loadScores(),this.startLeaderboardLoop()}hideLeaderboard(){this.leaderboard.style.display="none",this.leaderboardState.autoSwitch=!1,"gameOver"===this.gameState?this.gameOverScreen.style.display="block":(this.startScreen.style.display="block",this.startScreenLoop())}resetLeaderboardState(){this.leaderboardState.currentView="recent",this.leaderboardState.switchTimer=Date.now(),this.leaderboardState.autoSwitch=!0}startLeaderboardLoop(){"flex"===this.leaderboard.style.display&&this.leaderboardState.autoSwitch&&(this.updateLeaderboard(),setTimeout(()=>this.startLeaderboardLoop(),100))}updateLeaderboard(){const t=Date.now();t-this.leaderboardState.switchTimer>=this.leaderboardState.switchInterval&&(this.leaderboardState.currentView="recent"===this.leaderboardState.currentView?"ranking":"recent",this.leaderboardState.switchTimer=t,this.loadScores())}async loadScores(){try{if("recent"===this.leaderboardState.currentView){const t=await this.getScores();this.renderRecentScores(t)}else{const t=await this.getPlayerRankings();this.renderPlayerRankings(t)}}catch(t){}}renderRecentScores(t){this.leaderboardTitle.textContent="🏆 最近10局对战记录",0!==t.length?this.scoreList.innerHTML=t.map((t,e)=>{const i=0===e?"first":1===e?"second":2===e?"third":"",s=0===e?"🥇":1===e?"🥈":2===e?"🥉":e+1,a=new Date(t.date),h=`${a.getMonth()+1}/${a.getDate()} ${a.getHours()}:${a.getMinutes().toString().padStart(2,"0")}`,l=t.leftScore+t.leftBonus,r=t.rightScore+t.rightBonus,n=l>r;return`\n                <div class="score-item ${i}">\n                    <div class="score-rank">${s}</div>\n                    <div class="score-names">\n                        <div style="font-size: 20px; color: ${n?"#FFD700":"#ccc"}">\n                            ${t.leftPlayer}: ${l}\n                        </div>\n                        <div style="font-size: 16px; color: #666; margin: 2px 0;">VS</div>\n                        <div style="font-size: 20px; color: ${n?"#ccc":"#FFD700"}">\n                            ${t.rightPlayer}: ${r}\n                        </div>\n                        <div style="font-size: 14px; color: #888; margin-top: 4px;">${h}</div>\n                    </div>\n                    <div class="score-points">\n                        <div style="color: #4ECDC4; font-size: 24px;">${t.winner}</div>\n                        <div style="color: #96CEB4; font-size: 14px;">获胜</div>\n                    </div>\n                </div>\n            `}).join(""):this.scoreList.innerHTML='<div style="color: #ccc; font-size: 24px; text-align: center; padding: 40px;">暂无分数记录</div>'}renderPlayerRankings(t){this.leaderboardTitle.textContent="👑 玩家积分排行榜",0!==t.length?this.scoreList.innerHTML=t.map((t,e)=>{const i=0===e?"first":1===e?"second":2===e?"third":"",s=0===e?"🥇":1===e?"🥈":2===e?"🥉":`${e+1}`,a=t.games>0?Math.round(t.wins/t.games*100):0;return`\n                <div class="score-item ${i}">\n                    <div class="score-rank">${s}</div>\n                    <div class="score-names">\n                        <div style="font-size: 24px; color: #FFD700; font-weight: bold;">\n                            ${t.name}\n                        </div>\n                        <div style="font-size: 16px; color: #ccc; margin: 4px 0;">\n                            胜场: ${t.wins}/${t.games} (${a}%)\n                        </div>\n                        <div style="font-size: 14px; color: #888;">\n                            场均: ${(t.totalScore/Math.max(t.games,1)).toFixed(1)}分\n                        </div>\n                    </div>\n                    <div class="score-points">\n                        <div style="color: #4ECDC4; font-size: 28px; font-weight: bold;">${t.totalScore}</div>\n                        <div style="color: #96CEB4; font-size: 14px;">总积分</div>\n                    </div>\n                </div>\n            `}).join(""):this.scoreList.innerHTML='<div style="color: #ccc; font-size: 24px; text-align: center; padding: 40px;">暂无玩家数据</div>'}initializeTableSize(){const t=this.tableSizes[this.currentTableSize];this.canvas.width=t.width,this.canvas.height=t.height,this.updateGameElementsPosition()}updateGameElementsPosition(){const t=this.tableSizes[this.currentTableSize],e=t.tableWidth||t.width,i=t.tableHeight||t.height,s=(this.canvas.width-e)/2,a=(this.canvas.height-i)/2;this.leftPaddle.x=s+20,this.leftPaddle.y=a+i/2-this.paddleHeight/2,this.rightPaddle.x=s+e-30,this.rightPaddle.y=a+i/2-this.paddleHeight/2,this.ball.x=s+e/2,this.ball.y=a+i/2,this.leftCharacter.x=s-60,this.rightCharacter.x=s+e+20,this.leftCharacter.y=a+i/2,this.rightCharacter.y=a+i/2}getRandomBrightColor(){const t=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#FFB74D","#F06292","#81C784","#FFD54F"];return t[Math.floor(Math.random()*t.length)]}spawnApples(){const t=Date.now();if(t-this.appleSystem.lastSpawnTime>=16.67*this.appleSystem.spawnInterval&&this.apples.length<this.appleSystem.maxApples){const e=Math.min(Math.floor(3*Math.random())+1,this.appleSystem.maxApples-this.apples.length);for(let t=0;t<e;t++)this.createApple();this.appleSystem.spawnInterval=180+240*Math.random(),this.appleSystem.lastSpawnTime=t}}createApple(){const t=this.tableSizes[this.currentTableSize],e=t.tableWidth||t.width,i=t.tableHeight||t.height,s=(this.canvas.width-e)/2,a=(this.canvas.height-i)/2;let h,l=0,r=!1;for(;!r&&l<10;){h={x:s+.25*e+Math.random()*(.5*e),y:a+.125*i+Math.random()*(.75*i),size:48,blinkTimer:0,visible:!0,life:600+600*Math.random()},r=!0;for(const t of this.apples){if(Math.sqrt(Math.pow(h.x-t.x,2)+Math.pow(h.y-t.y,2))<100){r=!1;break}}l++}r&&this.apples.push(h)}updateApples(){this.spawnApples();for(let t=this.apples.length-1;t>=0;t--){const e=this.apples[t];if(e.blinkTimer++,e.blinkTimer%20==0&&(e.visible=!e.visible),e.life--,e.life<=0){this.apples.splice(t,1);continue}Math.sqrt(Math.pow(this.ball.x-e.x,2)+Math.pow(this.ball.y-e.y,2))<this.ball.size/2+e.size/2&&("left"===this.lastHitPlayer?(this.leftBonusScore++,this.triggerScoreAnimation(this.leftPlayerName+" 苹果奖励!","left"),this.enhanceCharacter("left")):"right"===this.lastHitPlayer||this.ball.dx>0?(this.rightBonusScore++,this.triggerScoreAnimation(this.rightPlayerName+" 苹果奖励!","right"),this.enhanceCharacter("right")):(this.leftBonusScore++,this.triggerScoreAnimation(this.leftPlayerName+" 苹果奖励!","left"),this.enhanceCharacter("left")),this.apples.splice(t,1),this.hitSound.currentTime=0,this.hitSound.play().catch(t=>{}))}}drawApples(){for(const t of this.apples){if(!t.visible)continue;const e=this.ctx,i=t.x,s=t.y,a=t.size/12;e.fillStyle="#FF4444",e.fillRect(i-4*a,s-2*a,8*a,6*a),e.fillRect(i-2*a,s-4*a,4*a,2*a),e.fillRect(i-3*a,s+4*a,6*a,2*a),e.fillStyle="#44FF44",e.fillRect(i+1*a,s-6*a,2*a,2*a),e.fillStyle="#8B4513",e.fillRect(i,s-5*a,1*a,1*a)}}drawPixelCharacter(t,e){const i=this.ctx,s=t.x,a=t.y,h=t.size,l=e?"#FF4444":"#44AAFF",r="#FFDBAC",n="#8B4513",o=t.isEnhanced?"#FFD700":null;i.save(),t.isEnhanced&&(i.shadowColor=o,i.shadowBlur=15),i.fillStyle=l,i.fillRect(s+8*h,a-5*h,14*h,20*h),i.fillRect(s+10*h,a-7*h,10*h,4*h),i.fillRect(s+10*h,a+15*h,10*h,4*h),i.fillStyle=r,i.fillRect(s+11*h,a-15*h,8*h,8*h),i.fillRect(s+13*h,a-17*h,4*h,4*h),i.fillStyle="#000",i.fillRect(s+14*h,a-13*h,1*h,1*h),i.fillRect(s+16*h,a-13*h,1*h,1*h);const d=3*Math.sin(t.animationFrame)*h;i.fillStyle=r,e?(i.fillRect(s+22*h,a-2*h+d,3*h,6*h),i.fillStyle=n,i.fillRect(s+25*h,a-4*h+d,5*h,2*h),i.fillRect(s+25*h,a+2*h+d,5*h,2*h)):(i.fillRect(s+5*h,a-2*h+d,3*h,6*h),i.fillStyle=n,i.fillRect(s,a-4*h+d,5*h,2*h),i.fillRect(s,a+2*h+d,5*h,2*h)),i.fillStyle=r,e?i.fillRect(s+5*h,a+1*h-d/2,3*h,5*h):i.fillRect(s+22*h,a+1*h-d/2,3*h,5*h);const c=1*Math.sin(t.animationFrame+Math.PI)*h;i.fillRect(s+10*h,a+19*h,3*h,8*h+c),i.fillRect(s+17*h,a+19*h,3*h,8*h-c),i.fillStyle="#000",i.fillRect(s+9*h,a+27*h+c,5*h,2*h),i.fillRect(s+16*h,a+27*h-c,5*h,2*h),t.animationFrame+=t.animationSpeed,i.restore()}triggerScoreAnimation(t,e){this.scoreAnimation.active=!0,this.scoreAnimation.currentFrame=0,this.scoreAnimation.text=`${t} 得分!`,this.scoreAnimation.x="left"===e?this.canvas.width/4:3*this.canvas.width/4,this.scoreAnimation.y=this.canvas.height/2,this.scoreAnimation.opacity=1,this.scoreAnimation.scale=1}updateScoreAnimation(){this.scoreAnimation.active&&(this.scoreAnimation.currentFrame++,this.scoreAnimation.currentFrame<30?this.scoreAnimation.scale=1+this.scoreAnimation.currentFrame/30*.5:(this.scoreAnimation.opacity=1-(this.scoreAnimation.currentFrame-30)/90,this.scoreAnimation.y-=1),this.scoreAnimation.currentFrame>=this.scoreAnimation.duration&&(this.scoreAnimation.active=!1))}drawScoreAnimation(){this.scoreAnimation.active&&(this.ctx.save(),this.ctx.globalAlpha=this.scoreAnimation.opacity,this.ctx.fillStyle="#FFD700",this.ctx.font=`bold ${24*this.scoreAnimation.scale}px Arial`,this.ctx.textAlign="center",this.ctx.strokeStyle="#000",this.ctx.lineWidth=2,this.ctx.strokeText(this.scoreAnimation.text,this.scoreAnimation.x,this.scoreAnimation.y),this.ctx.fillText(this.scoreAnimation.text,this.scoreAnimation.x,this.scoreAnimation.y),this.ctx.restore())}initGamepadSupport(){window.addEventListener("gamepadconnected",t=>{this.gamepads[t.gamepad.index]=t.gamepad,this.gamepadConnected=!0}),window.addEventListener("gamepaddisconnected",t=>{delete this.gamepads[t.gamepad.index],this.gamepadConnected=Object.keys(this.gamepads).length>0})}updateGamepads(){const t=navigator.getGamepads();for(let e=0;e<t.length;e++)t[e]&&(this.gamepads[e]=t[e],this.gamepadConnected=!0)}handleGamepadInput(){this.updateGamepads();let t=!1;for(let e in this.gamepads){const i=this.gamepads[e];if(i){if(t=!0,"start"===this.gameState){const t=i.axes[0],e=i.axes[1];this.cursor.visible=!0,Math.abs(t)>.2&&(this.cursor.x+=t*this.cursor.speed,this.cursor.x=Math.max(0,Math.min(window.innerWidth,this.cursor.x))),Math.abs(e)>.2&&(this.cursor.y+=e*this.cursor.speed,this.cursor.y=Math.max(0,Math.min(window.innerHeight,this.cursor.y))),i.buttons[0]&&i.buttons[0].pressed&&this.handleGamepadClick(),i.buttons[9]&&i.buttons[9].pressed&&this.startGame(),i.buttons[1]&&i.buttons[1].pressed&&this.resetNameInputs(),this.updateCursorDisplay()}else if(this.cursor.visible=!1,"gameOver"===this.gameState){this.cursor.visible=!0;const t=i.axes[0],e=i.axes[1];Math.abs(t)>.2&&(this.cursor.x+=t*this.cursor.speed,this.cursor.x=Math.max(0,Math.min(window.innerWidth,this.cursor.x))),Math.abs(e)>.2&&(this.cursor.y+=e*this.cursor.speed,this.cursor.y=Math.max(0,Math.min(window.innerHeight,this.cursor.y))),i.buttons[0]&&i.buttons[0].pressed&&this.handleGamepadClick(),(i.buttons[1]&&i.buttons[1].pressed||i.buttons[8]&&i.buttons[8].pressed)&&this.exitGame(),i.buttons[3]&&i.buttons[3].pressed&&this.toggleDetailedStats(),i.buttons[2]&&i.buttons[2].pressed&&this.resetGame(),this.updateCursorDisplay()}else"podium"===this.gameState&&i.buttons[0]&&i.buttons[0].pressed&&this.hidePodium();if("flex"===this.leaderboard.style.display&&(i.buttons[1]&&i.buttons[1].pressed||i.buttons[8]&&i.buttons[8].pressed)&&this.hideLeaderboard(),"playing"===this.gameState){if(0===parseInt(e)){const t=i.axes[1],e=i.buttons[12]&&i.buttons[12].pressed,s=i.buttons[13]&&i.buttons[13].pressed,a=i.buttons[2]&&i.buttons[2].pressed,h=i.buttons[0]&&i.buttons[0].pressed;if((t<-.3||e||a)&&this.leftPaddle.y>0){const t=this.leftPaddle.speed*this.leftCharacter.paddleSpeedMultiplier;this.leftPaddle.y-=t}if((t>.3||s||h)&&this.leftPaddle.y<this.canvas.height-this.leftPaddle.height){const t=this.leftPaddle.speed*this.leftCharacter.paddleSpeedMultiplier;this.leftPaddle.y+=t}}if(1===parseInt(e)||0===parseInt(e)&&1===Object.keys(this.gamepads).length){const t=1===parseInt(e)?i.axes[1]:i.axes[3],s=i.buttons[14]&&i.buttons[14].pressed,a=i.buttons[15]&&i.buttons[15].pressed,h=i.buttons[3]&&i.buttons[3].pressed,l=i.buttons[1]&&i.buttons[1].pressed,r=1===parseInt(e)&&i.buttons[12]&&i.buttons[12].pressed,n=1===parseInt(e)&&i.buttons[13]&&i.buttons[13].pressed;let o=!1;if((t<-.3||s||h||r)&&this.rightPaddle.y>0){const t=this.rightPaddle.speed*this.rightCharacter.paddleSpeedMultiplier;this.rightPaddle.y-=t,o=!0}if((t>.3||a||l||n)&&this.rightPaddle.y<this.canvas.height-this.rightPaddle.height){const t=this.rightPaddle.speed*this.rightCharacter.paddleSpeedMultiplier;this.rightPaddle.y+=t,o=!0}"唐林"===this.rightPlayerName&&o&&(this.autoMove.lastControlTime=Date.now(),this.autoMove.enabled=!1)}}}}t||(this.cursor.visible=!1)}handleGamepadClick(){const t=document.elementFromPoint(this.cursor.x,this.cursor.y);if(t){const e=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window,clientX:this.cursor.x,clientY:this.cursor.y});t.dispatchEvent(e)}}updateCursorDisplay(){const t=document.getElementById("gamepad-cursor");if(t&&t.remove(),this.cursor.visible){const t=document.createElement("div");t.id="gamepad-cursor",t.style.cssText=`\n                position: fixed;\n                left: ${this.cursor.x-10}px;\n                top: ${this.cursor.y-10}px;\n                width: 20px;\n                height: 20px;\n                background: radial-gradient(circle, #00ff00 0%, #008800 70%, transparent 100%);\n                border: 2px solid #ffffff;\n                border-radius: 50%;\n                pointer-events: none;\n                z-index: 10000;\n                box-shadow: 0 0 10px #00ff00;\n            `,document.body.appendChild(t)}}triggerGamepadVibration(t=200,e=.5){for(let i in this.gamepads){const s=this.gamepads[i];s&&s.vibrationActuator&&s.vibrationActuator.playEffect("dual-rumble",{startDelay:0,duration:t,weakMagnitude:.7*e,strongMagnitude:e}).catch(t=>{})}}initEventListeners(){document.addEventListener("keydown",t=>{this.keys[t.key.toLowerCase()]=!0,"start"===this.gameState?" "===t.key?this.startGame():"Enter"===t.key&&this.handleEnterKey():"gameOver"===this.gameState?"r"===t.key.toLowerCase()?this.resetGame():"Escape"===t.key?this.exitGame():"d"===t.key.toLowerCase()?this.toggleDetailedStats():"l"===t.key.toLowerCase()&&this.showLeaderboardFromGame():"podium"===this.gameState&&this.hidePodium(),"Escape"===t.key&&"flex"===this.leaderboard.style.display&&this.hideLeaderboard()}),document.addEventListener("keyup",t=>{this.keys[t.key.toLowerCase()]=!1}),this.leftPlayerInput.addEventListener("keydown",t=>{"Enter"===t.key&&this.setPlayerName("left")}),this.rightPlayerInput.addEventListener("keydown",t=>{"Enter"===t.key&&this.setPlayerName("right")})}startGame(){this.startScreen.style.display="none",this.leftPlayerName=this.leftPlayerInput.value.trim()||"小朋友",this.rightPlayerName=this.rightPlayerInput.value.trim()||"唐林",this.currentTableSize=this.tableSizeSelect.value,this.currentBackground=this.backgroundSelect.value,this.initializeTableSize(),this.leftPlayerDisplay.textContent=this.leftPlayerName,this.rightPlayerDisplay.textContent=this.rightPlayerName,this.gameUI.style.display="block",document.querySelector(".scoreboard").style.display="flex",this.canvas.style.display="block",this.gameOverScreen.style.display="none",this.gameState="playing",this.gameStartTime=Date.now(),this.autoMove.lastControlTime=Date.now(),this.autoMove.enabled=!1,this.autoMove.targetY=this.rightPaddle.y,this.autoMove.lastDecisionTime=0,this.autoMove.successRate=.8+.19*Math.random(),this.resetCharacterEnhancement("left"),this.resetCharacterEnhancement("right"),this.backgroundMusic.play().catch(t=>{}),this.updateScore(),this.gameLoop()}resetGame(){this.leftScore=0,this.rightScore=0,this.leftBonusScore=0,this.rightBonusScore=0,this.lastLoser=null,this.apples=[],this.appleSystem.spawnTimer=0,this.appleSystem.lastSpawnTime=Date.now(),this.ball.x=this.canvas.width/2,this.ball.y=this.canvas.height/2,this.ball.dx=this.ball.baseSpeed*(Math.random()>.5?1:-1),this.ball.dy=this.ball.baseSpeed*(Math.random()>.5?1:-1),this.ball.trail=[],this.ball.color=this.getRandomBrightColor(),this.leftPaddle.y=this.canvas.height/2-this.paddleHeight/2,this.rightPaddle.y=this.canvas.height/2-this.paddleHeight/2,this.gameUI.style.display="block",document.querySelector(".scoreboard").style.display="flex",this.canvas.style.display="block",this.gameOverScreen.style.display="none",this.detailedStats.style.display="none",this.showDetailedStats=!1,this.gameState="playing",this.gameStartTime=Date.now(),this.autoMove.lastControlTime=Date.now(),this.autoMove.enabled=!1,this.autoMove.targetY=this.rightPaddle.y,this.autoMove.lastDecisionTime=0,this.autoMove.successRate=.8+.19*Math.random(),this.resetCharacterEnhancement("left"),this.resetCharacterEnhancement("right"),this.updateScore(),this.gameLoop()}handleEnterKey(){document.activeElement===this.leftPlayerInput?this.setPlayerName("left"):document.activeElement===this.rightPlayerInput&&this.setPlayerName("right")}setPlayerName(t){if("left"!==t||this.leftNameSet){if("right"===t&&!this.rightNameSet){const t=this.rightPlayerInput.value.trim()||"唐林";this.rightPlayerName=t,this.rightPlayerDisplayDiv.textContent=t,this.rightPlayerDisplayDiv.style.display="block",this.rightPlayerInput.style.display="none",this.rightNameSet=!0}}else{const t=this.leftPlayerInput.value.trim()||"小鹏友";this.leftPlayerName=t,this.leftPlayerDisplayDiv.textContent=t,this.leftPlayerDisplayDiv.style.display="block",this.leftPlayerInput.style.display="none",this.leftNameSet=!0}this.updateStartHint()}updateStartHint(){const t=document.querySelector(".start-hint");t.textContent="按 SPACE 开始游戏",t.style.color="#00FF00"}exitGame(){this.gameOverScreen.style.display="none",this.detailedStats.style.display="none",this.gameUI.style.display="none",this.canvas.style.display="none",document.querySelector(".scoreboard").style.display="none",this.gameState="start",this.showDetailedStats=!1,this.startScreen.style.display="block",this.resetNameInputs(),this.startScreenLoop(),this.backgroundMusic.currentTime=0}resetNameInputs(){this.leftNameSet=!1,this.rightNameSet=!1,this.leftPlayerInput.style.display="block",this.rightPlayerInput.style.display="block",this.leftPlayerDisplayDiv.style.display="none",this.rightPlayerDisplayDiv.style.display="none",this.updateStartHint()}toggleDetailedStats(){this.showDetailedStats=!this.showDetailedStats,this.showDetailedStats?(this.updateDetailedStats(),this.detailedStats.style.display="block"):this.detailedStats.style.display="none"}updateDetailedStats(){const t=this.leftScore+this.leftBonusScore,e=this.rightScore+this.rightBonusScore;this.totalScores.textContent=`${this.leftPlayerName}: ${t} | ${this.rightPlayerName}: ${e}`,this.regularScores.textContent=`${this.leftPlayerName}: ${this.leftScore} | ${this.rightPlayerName}: ${this.rightScore}`,this.bonusScores.textContent=`${this.leftPlayerName}: ${this.leftBonusScore} | ${this.rightPlayerName}: ${this.rightBonusScore}`;const i=this.currentGameTime,s=Math.floor(i/6e4),a=Math.floor(i%6e4/1e3);this.gameDuration.textContent=`${s}分${a}秒`}updatePaddles(){this.handleGamepadInput();const t=this.leftPaddle.speed*this.leftCharacter.paddleSpeedMultiplier,e=this.rightPaddle.speed*this.rightCharacter.paddleSpeedMultiplier;(this.keys.a||this.keys.w)&&this.leftPaddle.y>0&&(this.leftPaddle.y-=t),(this.keys.z||this.keys.s)&&this.leftPaddle.y<this.canvas.height-this.leftPaddle.height&&(this.leftPaddle.y+=t);let i=!1;if((this.keys.arrowup||this.keys.arrowleft)&&this.rightPaddle.y>0&&(this.rightPaddle.y-=e,i=!0),(this.keys.arrowdown||this.keys.arrowright)&&this.rightPaddle.y<this.canvas.height-this.rightPaddle.height&&(this.rightPaddle.y+=e,i=!0),"唐林"===this.rightPlayerName){if(i)this.autoMove.lastControlTime=Date.now(),this.autoMove.enabled=!1;else{Date.now()-this.autoMove.lastControlTime>this.autoMove.activationDelay&&(this.autoMove.enabled=!0)}this.autoMove.enabled&&this.updateAutoMove()}this.updateCharacterEnhancement(this.leftCharacter),this.updateCharacterEnhancement(this.rightCharacter);const s=this.tableSizes[this.currentTableSize],a=s.tableHeight||s.height;this.canvas.height;this.leftCharacter.y=this.leftPaddle.y+this.leftPaddle.height/2,this.rightCharacter.y=this.rightPaddle.y+this.rightPaddle.height/2}updateAutoMove(){const t=Date.now();if(t-this.autoMove.lastDecisionTime<this.autoMove.reactionDelay)return;if(this.ball.dx>0){if(Math.random()<this.autoMove.successRate){const t=(this.rightPaddle.x-this.ball.x)/this.ball.dx,e=this.ball.y+this.ball.dy*t;this.autoMove.targetY=e-this.rightPaddle.height/2,this.autoMove.targetY=Math.max(0,Math.min(this.canvas.height-this.rightPaddle.height,this.autoMove.targetY))}else{const t=Math.random();this.autoMove.targetY=t<.3?this.rightPaddle.y:t<.6?this.ball.y>this.rightPaddle.y+this.rightPaddle.height/2?this.rightPaddle.y-100:this.rightPaddle.y+100:this.ball.y-this.rightPaddle.height/2,this.autoMove.targetY=Math.max(0,Math.min(this.canvas.height-this.rightPaddle.height,this.autoMove.targetY))}this.autoMove.lastDecisionTime=t}const e=this.rightPaddle.speed*this.rightCharacter.paddleSpeedMultiplier*1.2,i=this.autoMove.targetY-this.rightPaddle.y;Math.abs(i)>2&&(i>0&&this.rightPaddle.y<this.canvas.height-this.rightPaddle.height?this.rightPaddle.y+=Math.min(e,i):i<0&&this.rightPaddle.y>0&&(this.rightPaddle.y+=Math.max(-e,i)))}updateBall(){const t=(Math.sqrt(this.ball.dx*this.ball.dx+this.ball.dy*this.ball.dy)-this.ball.baseSpeed)/(8-this.ball.baseSpeed),e=Math.min(25,5+20*t);this.ball.trail.push({x:this.ball.x,y:this.ball.y}),this.ball.trail.length>Math.max(1,Math.round(e))&&this.ball.trail.shift(),this.ball.x+=this.ball.dx,this.ball.y+=this.ball.dy;const i=this.tableSizes[this.currentTableSize],s=i.tableWidth||i.width,a=i.tableHeight||i.height,h=(this.canvas.width-s)/2,l=(this.canvas.height-a)/2;if((this.ball.y<=l+this.ball.size||this.ball.y>=l+a-this.ball.size)&&(this.ball.dy=-this.ball.dy),this.ball.x-this.ball.size<=this.leftPaddle.x+this.leftPaddle.width&&this.ball.x+this.ball.size>=this.leftPaddle.x&&this.ball.y>=this.leftPaddle.y&&this.ball.y<=this.leftPaddle.y+this.leftPaddle.height){this.ball.dx=-this.ball.dx,this.increaseBallSpeed(),this.lastHitPlayer="left",this.hitSound.currentTime=0,this.hitSound.play().catch(t=>{}),this.triggerGamepadVibration(150,.6);let t=(this.ball.y-this.leftPaddle.y)/this.leftPaddle.height;this.ball.dy=8*(t-.5)}if(this.ball.x+this.ball.size>=this.rightPaddle.x&&this.ball.x-this.ball.size<=this.rightPaddle.x+this.rightPaddle.width&&this.ball.y>=this.rightPaddle.y&&this.ball.y<=this.rightPaddle.y+this.rightPaddle.height){this.ball.dx=-this.ball.dx,this.increaseBallSpeed(),this.lastHitPlayer="right",this.hitSound.currentTime=0,this.hitSound.play().catch(t=>{}),this.triggerGamepadVibration(150,.6);let t=(this.ball.y-this.rightPaddle.y)/this.rightPaddle.height;this.ball.dy=8*(t-.5)}this.ball.x<h?(this.triggerOutOfBoundsAnimation("left"),this.rightScore++,this.lastLoser="left",this.triggerScoreAnimation(this.rightPlayerName,"right"),this.resetCharacterEnhancement("left"),this.leftLostSound.currentTime=0,this.leftLostSound.play().catch(t=>{}),this.resetBall()):this.ball.x>h+s&&(this.triggerOutOfBoundsAnimation("right"),this.leftScore++,this.lastLoser="right",this.triggerScoreAnimation(this.leftPlayerName,"left"),this.resetCharacterEnhancement("right"),this.rightLostSound.currentTime=0,this.rightLostSound.play().catch(t=>{}),this.resetBall()),(this.leftScore+this.leftBonusScore>=this.winningScore||this.rightScore+this.rightBonusScore>=this.winningScore)&&this.endGame()}increaseBallSpeed(){Math.sqrt(this.ball.dx*this.ball.dx+this.ball.dy*this.ball.dy)<8&&(this.ball.dx*=1.05,this.ball.dy*=1.05)}triggerOutOfBoundsAnimation(t){this.outOfBoundsAnimation.active=!0,this.outOfBoundsAnimation.currentFrame=0,this.outOfBoundsAnimation.particles=[];let e="left"===t?0:this.canvas.width,i=this.ball.y;for(let t=0;t<20;t++)this.outOfBoundsAnimation.particles.push({x:e,y:i,vx:8*(Math.random()-.5),vy:8*(Math.random()-.5),life:1,decay:.02+.02*Math.random(),size:3+4*Math.random()})}updateOutOfBoundsAnimation(){if(this.outOfBoundsAnimation.active){this.outOfBoundsAnimation.currentFrame++;for(let t of this.outOfBoundsAnimation.particles)t.x+=t.vx,t.y+=t.vy,t.vx*=.98,t.vy*=.98,t.life-=t.decay;this.outOfBoundsAnimation.particles=this.outOfBoundsAnimation.particles.filter(t=>t.life>0),this.outOfBoundsAnimation.currentFrame>=this.outOfBoundsAnimation.duration&&(this.outOfBoundsAnimation.active=!1)}}resetBall(){const t=this.tableSizes[this.currentTableSize],e=t.tableWidth||t.width,i=t.tableHeight||t.height,s=(this.canvas.width-e)/2,a=(this.canvas.height-i)/2;this.ball.x=s+e/2,this.ball.y=a+i/2,"left"===this.lastLoser?this.ball.dx=Math.abs(this.ball.baseSpeed):"right"===this.lastLoser?this.ball.dx=-Math.abs(this.ball.baseSpeed):this.ball.dx=this.ball.baseSpeed*(Math.random()>.5?1:-1),this.ball.dy=this.ball.baseSpeed*(Math.random()>.5?1:-1),this.ball.trail=[],this.ball.color=this.getRandomBrightColor(),this.lastHitPlayer=null,this.updateScore()}updateScore(){if(this.leftScoreDisplay.textContent=this.leftScore+this.leftBonusScore,this.rightScoreDisplay.textContent=this.rightScore+this.rightBonusScore,this.leftBonusScoreDisplay.textContent=`奖励: ${this.leftBonusScore}`,this.rightBonusScoreDisplay.textContent=`奖励: ${this.rightBonusScore}`,"playing"===this.gameState){this.currentGameTime=Date.now()-this.gameStartTime;let t=Math.floor(this.currentGameTime/6e4),e=Math.floor(this.currentGameTime%6e4/1e3);this.gameTimeDisplay.textContent=`${t.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}}endGame(){this.gameState="podium",this.gameUI.style.display="none",this.gameEndSound.currentTime=0,this.gameEndSound.play().catch(t=>{});const t=this.leftScore+this.leftBonusScore;this.rightScore,this.rightBonusScore;this.saveScore(this.leftPlayerName,this.rightPlayerName,this.leftScore,this.leftBonusScore,this.rightScore,this.rightBonusScore,this.currentGameTime),this.showPodium(t>=this.winningScore?"left":"right")}drawBackground(){const t=this.backgrounds[this.currentBackground],e=this.tableSizes[this.currentTableSize],i=e.tableWidth||e.width,s=e.tableHeight||e.height,a=(this.canvas.width-i)/2,h=(this.canvas.height-s)/2;switch(this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=t.base,this.ctx.fillRect(a,h,i,s),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=3,this.ctx.strokeRect(a,h,i,s),this.ctx.save(),this.ctx.globalAlpha=.1,this.ctx.beginPath(),this.ctx.rect(a,h,i,s),this.ctx.clip(),t.pattern){case"dots":this.drawDotsPattern(a,h,i,s);break;case"lines":this.drawLinesPattern(a,h,i,s);break;case"wood":this.drawWoodPattern(a,h,i,s);break;case"grid":this.drawGridPattern(a,h,i,s)}this.ctx.restore()}drawDotsPattern(t,e,i,s){this.ctx.fillStyle="#fff";for(let a=t+20;a<t+i;a+=40)for(let t=e+20;t<e+s;t+=40)this.ctx.beginPath(),this.ctx.arc(a,t,2,0,2*Math.PI),this.ctx.fill()}drawLinesPattern(t,e,i,s){this.ctx.strokeStyle="#fff",this.ctx.lineWidth=1;for(let a=e;a<e+s;a+=20)this.ctx.beginPath(),this.ctx.moveTo(t,a),this.ctx.lineTo(t+i,a),this.ctx.stroke()}drawWoodPattern(t,e,i,s){this.ctx.strokeStyle="#654321",this.ctx.lineWidth=2;for(let a=e+10;a<e+s;a+=30)this.ctx.beginPath(),this.ctx.moveTo(t,a+5*Math.sin(.02*a)),this.ctx.lineTo(t+i,a+5*Math.sin(.02*a)),this.ctx.stroke()}drawGridPattern(t,e,i,s){this.ctx.strokeStyle="#00ffff",this.ctx.lineWidth=1;for(let a=t;a<t+i;a+=30)this.ctx.beginPath(),this.ctx.moveTo(a,e),this.ctx.lineTo(a,e+s),this.ctx.stroke();for(let a=e;a<e+s;a+=30)this.ctx.beginPath(),this.ctx.moveTo(t,a),this.ctx.lineTo(t+i,a),this.ctx.stroke()}draw(){this.drawBackground();const t=this.tableSizes[this.currentTableSize],e=t.tableWidth||t.width,i=t.tableHeight||t.height,s=(this.canvas.width-e)/2,a=(this.canvas.height-i)/2;this.ctx.strokeStyle="#333",this.ctx.lineWidth=2,this.ctx.setLineDash([10,10]),this.ctx.beginPath(),this.ctx.moveTo(s+e/2,a),this.ctx.lineTo(s+e/2,a+i),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="#fff",this.ctx.fillRect(this.leftPaddle.x,this.leftPaddle.y,this.leftPaddle.width,this.leftPaddle.height),this.ctx.fillRect(this.rightPaddle.x,this.rightPaddle.y,this.rightPaddle.width,this.rightPaddle.height),this.drawPixelCharacter(this.leftCharacter,!0),this.drawPixelCharacter(this.rightCharacter,!1);for(let t=0;t<this.ball.trail.length;t++){let e=(t+1)/this.ball.trail.length*.8;this.ctx.fillStyle=this.ball.color+Math.floor(255*e).toString(16).padStart(2,"0"),this.ctx.beginPath();let i=this.ball.size*e;this.ctx.arc(this.ball.trail[t].x,this.ball.trail[t].y,i/2,0,2*Math.PI),this.ctx.fill()}this.ctx.fillStyle=this.ball.color,this.ctx.beginPath(),this.ctx.arc(this.ball.x,this.ball.y,this.ball.size/2,0,2*Math.PI),this.ctx.fill(),this.ctx.save(),this.ctx.shadowColor=this.ball.color,this.ctx.shadowBlur=15,this.ctx.beginPath(),this.ctx.arc(this.ball.x,this.ball.y,this.ball.size/2,0,2*Math.PI),this.ctx.fill(),this.ctx.restore(),this.drawOutOfBoundsAnimation(),this.drawScoreAnimation(),this.drawApples()}enhanceCharacter(t){const e="left"===t?this.leftCharacter:this.rightCharacter;if(e.enhancementCount<5){e.enhancementCount++,e.isEnhanced=!0,e.paddleSpeedMultiplier=1+.2*e.enhancementCount,e.paddleHeightMultiplier=1+.1*e.enhancementCount,e.size=2+.2*e.enhancementCount,e.enhancedTimer=0;("left"===t?this.leftPaddle:this.rightPaddle).height=this.paddleHeight*e.paddleHeightMultiplier}}updateCharacterEnhancement(t){}resetCharacterEnhancement(t){const e="left"===t?this.leftCharacter:this.rightCharacter,i="left"===t?this.leftPaddle:this.rightPaddle;e.isEnhanced=!1,e.size=2,e.paddleSpeedMultiplier=1,e.paddleHeightMultiplier=1,e.enhancedTimer=0,e.enhancementCount=0,i.height=this.paddleHeight}drawOutOfBoundsAnimation(){if(this.outOfBoundsAnimation.active){for(let t of this.outOfBoundsAnimation.particles)this.ctx.save(),this.ctx.globalAlpha=t.life,this.ctx.fillStyle="#ff6666",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.size,0,2*Math.PI),this.ctx.fill(),this.ctx.restore();this.outOfBoundsAnimation.currentFrame<30&&(this.ctx.save(),this.ctx.globalAlpha=1-this.outOfBoundsAnimation.currentFrame/30,this.ctx.fillStyle="#ff4444",this.ctx.font="bold 24px Arial",this.ctx.textAlign="center",this.ctx.fillText("出界!",this.canvas.width/2,this.canvas.height/2+50),this.ctx.restore())}}gameLoop(){"playing"===this.gameState&&(this.updatePaddles(),this.updateBall(),this.updateApples(),this.updateOutOfBoundsAnimation(),this.updateScoreAnimation(),this.updateScore(),this.draw(),requestAnimationFrame(()=>this.gameLoop()))}showPodium(t){this.podiumState.active=!0,this.podiumState.winner=t,this.podiumState.countdown=20,this.podiumState.countdownTimer=0,this.podiumState.animationFrame=0,this.podiumState.fireworks=[],this.podiumState.tears=[],this.podiumState.winnerDance.frame=0,this.podiumState.loserSad.frame=0,this.podiumScreen.style.display="flex";const e="left"===t?this.leftPlayerName:this.rightPlayerName;this.podiumWinner.textContent=`🎉 恭喜 ${e} 获得胜利！🎉`,this.podiumLoop()}podiumLoop(){"podium"===this.gameState&&this.podiumState.active&&(this.updatePodium(),this.drawPodium(),requestAnimationFrame(()=>this.podiumLoop()))}updatePodium(){this.podiumState.countdownTimer++,this.podiumState.countdownTimer>=60&&(this.podiumState.countdown--,this.podiumState.countdownTimer=0,this.podiumCountdown.textContent=Math.max(0,this.podiumState.countdown),this.podiumState.countdown<=0)?this.hidePodium():(this.podiumState.animationFrame++,this.podiumState.winnerDance.frame+=this.podiumState.winnerDance.speed,this.podiumState.loserSad.frame+=this.podiumState.loserSad.speed,this.podiumState.animationFrame%10==0&&this.createFirework(),this.podiumState.animationFrame%30==0&&this.createTears(),this.updateFireworks(),this.updateTears())}createFirework(){const t=Math.random()*this.podiumCanvas.width,e=200*Math.random()+200;for(let i=0;i<8;i++){const s=2*Math.PI*i/8,a=2+3*Math.random(),h=this.getRandomBrightColor();this.podiumState.fireworks.push({x:t,y:e,vx:Math.cos(s)*a,vy:Math.sin(s)*a,life:1,decay:.015,color:h,size:3+2*Math.random()})}}updateFireworks(){for(let t=this.podiumState.fireworks.length-1;t>=0;t--){const e=this.podiumState.fireworks[t];e.x+=e.vx,e.y+=e.vy,e.vy+=.1,e.life-=e.decay,e.life<=0&&this.podiumState.fireworks.splice(t,1)}}createTears(){const t=this.podiumCanvas.width/2-150,e=this.podiumCanvas.height-150-80-50;for(let i=0;i<2;i++)this.podiumState.tears.push({x:t+(0===i?-3:3),y:e-10,vx:.5*(Math.random()-.5),vy:.5+.5*Math.random(),life:1,decay:.01,size:2+Math.random()})}updateTears(){for(let t=this.podiumState.tears.length-1;t>=0;t--){const e=this.podiumState.tears[t];e.x+=e.vx,e.y+=e.vy,e.vy+=.02,e.life-=e.decay,e.life<=0&&this.podiumState.tears.splice(t,1)}}drawPodium(){this.podiumCtx&&(this.podiumCtx.fillStyle="rgba(30, 60, 114, 0.1)",this.podiumCtx.fillRect(0,0,this.podiumCanvas.width,this.podiumCanvas.height),this.drawPodiumPlatform(),this.drawPodiumCharacters(),this.drawFireworks(),this.drawTears())}drawPodiumPlatform(){const t=this.podiumCtx,e=this.podiumCanvas.width/2,i=this.podiumCanvas.height-150;t.fillStyle="#FFD700",t.fillRect(e-60,i-120,120,120),t.fillStyle="#FFA500",t.fillRect(e-60,i-125,120,5),t.fillStyle="#C0C0C0",t.fillRect(e-200,i-80,100,80),t.fillStyle="#A0A0A0",t.fillRect(e-200,i-85,100,5),t.fillStyle="#fff",t.font="bold 24px Arial",t.textAlign="center",t.fillText("🥇",e,i-60),t.fillText("🥈",e-150,i-40)}drawPodiumCharacters(){const t=this.podiumCtx,e=this.podiumCanvas.width/2,i=this.podiumCanvas.height-150,s="left"===this.podiumState.winner?this.leftCharacter:this.rightCharacter,a="left"===this.podiumState.winner?this.rightCharacter:this.leftCharacter,h=e,l=i-120-50,r=10*Math.sin(this.podiumState.winnerDance.frame),n=20*Math.sin(2*this.podiumState.winnerDance.frame);this.drawPodiumCharacter(t,h,l+r,s,!0,n);const o=e-150,d=i-80-50,c=2*Math.sin(this.podiumState.loserSad.frame);this.drawPodiumCharacter(t,o,d+c,a,!1,0)}drawPodiumCharacter(t,e,i,s,a,h){const l=s===this.leftCharacter?"#FF4444":"#44AAFF",r="#FFDBAC";t.save(),a&&(t.shadowColor="#FFD700",t.shadowBlur=20),t.fillStyle=l,t.fillRect(e-10.5,i-7.5,21,30),t.fillStyle=r,t.fillRect(e-6,i-22.5,12,12),t.fillStyle="#000",a?(t.fillRect(e-3,i-19.5,1.5,1.5),t.fillRect(e+1.5,i-19.5,1.5,1.5),t.beginPath(),t.arc(e,i-15,3,0,Math.PI),t.stroke()):(t.fillRect(e-3,i-19.5,1.5,3),t.fillRect(e+1.5,i-19.5,1.5,3),t.beginPath(),t.arc(e,i-12,3,Math.PI,0),t.stroke()),t.fillStyle=r,a?(t.fillRect(e-15,i-3+h/2,4.5,9),t.fillRect(e+10.5,i-3-h/2,4.5,9)):(t.fillRect(e-15,i+3,4.5,9),t.fillRect(e+10.5,i+3,4.5,9)),t.fillRect(e-4.5,i+22.5,3,12),t.fillRect(e+1.5,i+22.5,3,12),t.restore()}drawFireworks(){const t=this.podiumCtx;for(const e of this.podiumState.fireworks)t.save(),t.globalAlpha=e.life,t.fillStyle=e.color,t.beginPath(),t.arc(e.x,e.y,e.size,0,2*Math.PI),t.fill(),t.restore()}drawTears(){const t=this.podiumCtx;for(const e of this.podiumState.tears)t.save(),t.globalAlpha=e.life,t.fillStyle="#87CEEB",t.beginPath(),t.arc(e.x,e.y,e.size,0,2*Math.PI),t.fill(),t.restore()}hidePodium(){this.podiumState.active=!1,this.podiumScreen.style.display="none",this.showGameOverScreen()}showGameOverScreen(){this.gameState="gameOver",this.gameOverScreen.style.display="block";const t=this.leftScore+this.leftBonusScore,e=this.rightScore+this.rightBonusScore;t>=this.winningScore?this.winnerText.textContent=`${this.leftPlayerName}获胜！`:this.winnerText.textContent=`${this.rightPlayerName}获胜！`,this.finalScore.textContent=`最终比分：${t} - ${e}\n        (${this.leftPlayerName}: ${this.leftScore}+${this.leftBonusScore} | ${this.rightPlayerName}: ${this.rightScore}+${this.rightBonusScore})`}}var game=new PingPongGame;